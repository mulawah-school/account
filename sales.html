<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="style.css"/>
  <title>ุงูุจูุน</title>
</head>
<body>
<div class="container">
  <div class="top">
    <a class="badge" href="index.html">โฌ ุงูุฑุฆูุณูุฉ</a>
    <h2>๐งพ ุงูุจูุน</h2>
  </div>

  <div class="card">
    <div class="row">
      <input id="q" placeholder="ุจุญุซ (SKU ุฃู ุงุณู)"/>
      <button id="search">ุจุญุซ</button>
      <span class="badge" id="hint">โ</span>
    </div>

    <div class="row">
      <select id="productSelect"></select>
      <input id="qty" type="number" step="0.001" placeholder="ุงููููุฉ ุงููุจุงุนุฉ"/>
      <button id="add">ุฅุถุงูุฉ ููุณูุฉ</button>
      <span class="badge" id="stockLine">ุงููุชููุฑ: โ</span>
    </div>

    <table>
      <thead><tr><th>ุงูุตูู</th><th>ุงููููุฉ</th><th>ุงูุณุนุฑ</th><th>ุงูุฅุฌูุงูู</th></tr></thead>
      <tbody id="cart"></tbody>
    </table>

    <div class="row" style="margin-top:12px">
      <select id="pay">
        <option value="cash">ููุฏู</option>
        <option value="bank">ุชุญููู</option>
        <option value="deferred">ุฏูู ูุคุฌู</option>
      </select>

      <input id="paid" type="number" step="0.001" placeholder="ุงููุฏููุน ุงูุขู (OMR)" value="0"/>
      <span class="badge" id="total">ุงูุฅุฌูุงูู: 0</span>
    </div>

    <div class="row" id="deferredBox" style="display:none">
      <input id="cname" placeholder="ุงุณู ุงูุนููู"/>
      <input id="cphone" placeholder="ุฑูู ุงููุงุชู (ูุซุงู +968...)"/>
      <input id="due" placeholder="ุชุงุฑูุฎ ุงูุงุณุชุญูุงู (ุงุฎุชูุงุฑู) YYYY-MM-DD"/>
    </div>

    <div class="row">
      <button id="save">ุญูุธ ุงูุจูุน</button>
      <button id="clear">ูุณุญ ุงูุณูุฉ</button>
    </div>
  </div>

  <!-- โ ุณุฌู ุงูููุชุฌุงุช ุงููุจุงุนุฉ + ุงููุฌููุน ุจุงูุฃุณูู -->
  <hr/>
  <div class="card" style="margin-top:12px">
    <h3>ุณุฌู ุงูููุชุฌุงุช ุงููุจุงุนุฉ</h3>

    <table>
      <thead>
        <tr>
          <th>ุงูุชุงุฑูุฎ</th>
          <th>ุงูุตูู</th>
          <th>ุงููููุฉ</th>
          <th>ุงูุณุนุฑ</th>
          <th>ุงูุฅุฌูุงูู</th>
          <th>ุทุฑููุฉ ุงูุฏูุน</th>
          <th>ุงูุนููู</th>
        </tr>
      </thead>
      <tbody id="soldRows"></tbody>
    </table>

    <div class="row" style="justify-content:space-between; align-items:center; margin-top:10px">
      <span class="badge" id="soldCount">ุนุฏุฏ ุงูุนูุงุตุฑ: 0</span>
      <span class="badge" id="soldTotal">ูุฌููุน ุงููุจูุนุงุช: 0.000 OMR</span>
    </div>
  </div>

</div>

<script type="module">
import { getDB, findProducts, getStockNow, createSale } from "./app.js";

let db = getDB();
let list = [];
let cart = [];

function renderList(q=""){
  db = getDB();
  list = findProducts(db, q);
  const sel = document.querySelector("#productSelect");
  sel.innerHTML = list.map(p => `<option value="${p.id}">${p.sku} - ${p.name}</option>`).join("");
  document.querySelector("#hint").textContent = `ูุชุงุฆุฌ: ${list.length}`;
  updateStockLine();
}

function updateStockLine(){
  const pid = Number(document.querySelector("#productSelect").value);
  if(!pid){ document.querySelector("#stockLine").textContent = "ุงููุชููุฑ: โ"; return; }
  const stock = getStockNow(db, pid);
  document.querySelector("#stockLine").textContent = `ุงููุชููุฑ: ${stock}`;
}

function renderCart(){
  const tbody = document.querySelector("#cart");
  tbody.innerHTML = cart.map(it=>{
    return `<tr>
      <td>${it.name}</td>
      <td>${it.qty}</td>
      <td>${Number(it.price).toFixed(3)} OMR</td>
      <td>${(it.qty*it.price).toFixed(3)} OMR</td>
    </tr>`;
  }).join("");

  const total = cart.reduce((s,it)=>s+it.qty*it.price,0);
  document.querySelector("#total").textContent = `ุงูุฅุฌูุงูู: ${total.toFixed(3)} OMR`;
}

/* โ ุฌุฏูุฏ: ุณุฌู ุงููุจูุนุงุช (ูู ุงูููุชุฌุงุช ุงููุจุงุนุฉ) + ุงููุฌููุน */
function renderSalesHistory(){
  const db = getDB();
  const cur = db.currency || "OMR";

  const rows = [];
  for(const s of db.sales){
    for(const it of s.items){
      const p = db.products.find(x=>x.id===it.productId);
      const name = p ? `${p.sku} - ${p.name}` : `#${it.productId}`;
      rows.push({
        date: s.date,
        name,
        qty: Number(it.qty),
        price: Number(it.price),
        lineTotal: Number(it.qty) * Number(it.price),
        paymentMethod: s.paymentMethod,
        customer: s.paymentMethod === "deferred" ? (s.customerName || "") : ""
      });
    }
  }

  // ุงูุฃุญุฏุซ ุฃููุงู
  rows.sort((a,b)=> (a.date < b.date ? 1 : -1));

  const tbody = document.querySelector("#soldRows");
  tbody.innerHTML = rows.map(r=>`
    <tr>
      <td>${r.date}</td>
      <td>${r.name}</td>
      <td>${r.qty}</td>
      <td>${r.price.toFixed(3)} ${cur}</td>
      <td>${r.lineTotal.toFixed(3)} ${cur}</td>
      <td>${r.paymentMethod}</td>
      <td>${r.customer}</td>
    </tr>
  `).join("");

  const total = rows.reduce((s,r)=> s + r.lineTotal, 0);
  document.querySelector("#soldCount").textContent = `ุนุฏุฏ ุงูุนูุงุตุฑ: ${rows.length}`;
  document.querySelector("#soldTotal").textContent = `ูุฌููุน ุงููุจูุนุงุช: ${total.toFixed(3)} ${cur}`;
}

document.querySelector("#search").onclick = ()=> renderList(document.querySelector("#q").value);
document.querySelector("#productSelect").onchange = updateStockLine;

document.querySelector("#add").onclick = ()=>{
  db = getDB();
  const pid = Number(document.querySelector("#productSelect").value);
  const qty = Number(document.querySelector("#qty").value);
  const p = db.products.find(x=>x.id===pid);
  if(!p) return alert("ุงุฎุชุฑ ุตูู");

  const stock = getStockNow(db, pid);
  if(!(qty>0)) return alert("ูููุฉ ุบูุฑ ุตุญูุญุฉ");
  if(qty > stock) return alert(`ุงููุฎุฒูู ูุง ูููู. ุงููุชููุฑ: ${stock}`);

  cart.push({ productId: pid, name: p.name, qty, price: Number(p.price) });
  document.querySelector("#stockLine").textContent = `ุงููุชููุฑ ูุจู: ${stock} | ุงููุชุจูู ุจุนุฏ: ${stock - qty}`;
  renderCart();
};

document.querySelector("#pay").onchange = ()=>{
  document.querySelector("#deferredBox").style.display =
    document.querySelector("#pay").value === "deferred" ? "flex" : "none";
};

document.querySelector("#save").onclick = ()=>{
  try{
    db = getDB();
    const sale = createSale(db, {
      items: cart.map(it=>({productId: it.productId, qty: it.qty})),
      paymentMethod: document.querySelector("#pay").value,
      paid: document.querySelector("#paid").value,
      customerName: document.querySelector("#cname").value,
      customerPhone: document.querySelector("#cphone").value,
      dueDate: document.querySelector("#due").value ? (document.querySelector("#due").value + " 00:00:00") : ""
    });

    alert(`ุชู ุญูุธ ุงูุจูุน. ุงูุฅุฌูุงูู: ${Number(sale.total).toFixed(3)} OMR`);

    cart = [];
    renderCart();
    renderList(document.querySelector("#q").value);

    // โ ููู: ุชุญุฏูุซ ุณุฌู ุงูููุชุฌุงุช ุงููุจุงุนุฉ ุจุนุฏ ุงูุญูุธ
    renderSalesHistory();
  }catch(e){ alert(e.message); }
};

document.querySelector("#clear").onclick = ()=>{ cart=[]; renderCart(); };

// ุนูุฏ ูุชุญ ุงูุตูุญุฉ
renderList();
renderCart();
renderSalesHistory();
</script>
</body>
</html>
