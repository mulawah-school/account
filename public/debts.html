<!doctype html>
<html lang="ar" dir="rtl">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ù„</title>
<style>
body{font-family:system-ui;margin:24px} input,button{padding:10px;border-radius:10px;border:1px solid #ddd}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
table{width:100%;border-collapse:collapse;margin-top:12px} th,td{border:1px solid #eee;padding:8px}
</style>
</head>
<body>
<a href="/">â¬… Ø±Ø¬ÙˆØ¹</a>
<h2>ğŸ“± Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ù„</h2>

<div class="row">
  <input id="q" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ" />
  <button id="search">Ø¨Ø­Ø«</button>
</div>

<table>
  <thead>
    <tr><th>ID</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø£ØµÙ„</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr>
  </thead>
  <tbody id="tbl"></tbody>
</table>

<h3>Ø³Ø¯Ø§Ø¯ Ø¯ÙŠÙ†</h3>
<div class="row">
  <input id="did" placeholder="Debt ID" type="number"/>
  <input id="amt" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" type="number" step="0.001"/>
  <select id="pm"><option value="cash">Ù†Ù‚Ø¯ÙŠ</option><option value="bank">ØªØ­ÙˆÙŠÙ„</option></select>
  <button id="pay">ØªØ³Ø¬ÙŠÙ„ Ø³Ø¯Ø§Ø¯</button>
</div>

<script type="module">
import { api, qs } from "./app.js";

async function load(q=""){
  const data = await api("/api/debts?q="+encodeURIComponent(q));
  qs("#tbl").innerHTML = data.map(d=>`
    <tr>
      <td>${d.id}</td>
      <td>${d.customer_name}</td>
      <td>${d.customer_phone}</td>
      <td>${d.original_amount}</td>
      <td>${d.remaining_amount}</td>
      <td>${d.status}</td>
      <td>
        <button data-send="${d.id}">Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨</button>
      </td>
    </tr>
  `).join("");

  document.querySelectorAll("button[data-send]").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = btn.getAttribute("data-send");
      try{
        await api("/api/whatsapp/send-debt/"+id,"POST",{});
        alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø¥Ø°Ø§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§ØªØ³Ø§Ø¨ ØµØ­ÙŠØ­Ø©)");
      }catch(e){
        alert("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + e.message);
      }
    };
  });
}

qs("#search").onclick = ()=> load(qs("#q").value);

qs("#pay").onclick = async ()=>{
  const id = Number(qs("#did").value);
  const amount = Number(qs("#amt").value);
  const payment_method = qs("#pm").value;
  await api(`/api/debts/${id}/pay`,"POST",{ amount, payment_method });
  alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø¯Ø§Ø¯");
  load(qs("#q").value);
};

load();
</script>
</body>
</html>
