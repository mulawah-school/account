<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="style.css"/>
  <title>Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ù„</title>
</head>
<body>
<div class="container">
  <div class="top">
    <a class="badge" href="index.html">â¬… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <h2>ğŸ“± Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ù„</h2>
  </div>

  <div class="danger">
    ØªÙ†Ø¨ÙŠÙ‡: ØªØ®Ø²ÙŠÙ† UltraMsg token Ø¯Ø§Ø®Ù„ HTML/LocalStorage ØºÙŠØ± Ø¢Ù…Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³ØªØ¶Ø§ÙØ© Ø§Ù„Ø¹Ø§Ù…Ø© (GitHub Pages).
    Ø§Ù„Ø£ÙØ¶Ù„ Proxy. (Ù„Ùˆ ØªØ¨ÙŠ Ø£Ø¹Ø·ÙŠÙƒ Ø­Ù„ Proxy Ø¨Ø³ÙŠØ· Ø¬Ø¯Ù‹Ø§)
  </div>

  <div class="card" style="margin-top:12px">
    <h3>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª UltraMsg</h3>
    <div class="row">
      <input id="instanceId" placeholder="instance_id"/>
      <input id="token" placeholder="token"/>
      <button id="saveCfg">Ø­ÙØ¸</button>
    </div>
    <div class="small">
      Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙŠØªÙ… Ø¹Ø¨Ø± endpoint: /messages/chat (token,to,body) :contentReference[oaicite:2]{index=2}
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="row">
      <input id="q" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ"/>
      <button id="search">Ø¨Ø­Ø«</button>
    </div>

    <table>
      <thead><tr><th>ID</th><th>Ø§Ù„Ø¹Ù…ÙŠÙ„</th><th>Ø§Ù„Ù‡Ø§ØªÙ</th><th>Ø§Ù„Ø£ØµÙ„</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>ÙˆØ§ØªØ³Ø§Ø¨</th></tr></thead>
      <tbody id="tbl"></tbody>
    </table>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>Ø³Ø¯Ø§Ø¯ Ø¯ÙŠÙ†</h3>
    <div class="row">
      <input id="debtId" type="number" placeholder="Debt ID"/>
      <input id="amount" type="number" step="0.001" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø³Ø¯Ø§Ø¯"/>
      <button id="pay">ØªØ³Ø¬ÙŠÙ„ Ø³Ø¯Ø§Ø¯</button>
    </div>
  </div>
</div>

<script type="module">
import { getDB, setUltraMsg, payDebt, ultramsgSendChat } from "./app.js";

let db = getDB();

function loadCfg(){
  db = getDB();
  document.querySelector("#instanceId").value = db.ultramsg?.instanceId || "";
  document.querySelector("#token").value = db.ultramsg?.token || "";
}

function render(q=""){
  db = getDB();
  const t = (q||"").trim();
  const rows = t
    ? db.debts.filter(d => d.customerName.includes(t) || d.customerPhone.includes(t))
    : db.debts;

  document.querySelector("#tbl").innerHTML = rows.map(d=>{
    return `<tr>
      <td>${d.id}</td>
      <td>${d.customerName}</td>
      <td>${d.customerPhone}</td>
      <td>${Number(d.original).toFixed(3)}</td>
      <td>${Number(d.remaining).toFixed(3)}</td>
      <td>${d.status}</td>
      <td><button data-id="${d.id}">Ø¥Ø±Ø³Ø§Ù„</button></td>
    </tr>`;
  }).join("");

  document.querySelectorAll("button[data-id]").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = Number(btn.getAttribute("data-id"));
      const debt = getDB().debts.find(x=>x.id===id);
      if(!debt) return alert("Ø§Ù„Ø¯ÙŠÙ† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");

      const msg = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ${debt.customerName}
ØªØ°ÙƒÙŠØ±: Ù„Ø¯ÙŠÙƒ Ø¯ÙŠÙ† Ù…Ø¤Ø¬Ù„ Ù…ØªØ¨Ù‚ÙŠ ${Number(debt.remaining).toFixed(3)}
Ø´ÙƒØ±Ø§Ù‹`;

      try{
        // UltraMsg ÙŠØªØ·Ù„Ø¨ "to" Ø±Ù‚Ù… Ø¯ÙˆÙ„ÙŠ Ù…Ø«Ù„ +1415... :contentReference[oaicite:3]{index=3}
        await ultramsgSendChat(getDB(), { to: debt.customerPhone, body: msg });
        alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ (Ø¥Ø°Ø§ Ù…Ø§ Ø¸Ù‡Ø±Øª Ù…Ø´ÙƒÙ„Ø© CORS)");
      }catch(e){
        alert("ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: " + e.message + "\nÙ…Ù„Ø§Ø­Ø¸Ø©: Ù„Ùˆ Ø¸Ù‡Ø± CORS ØªØ­ØªØ§Ø¬ Proxy Ø¨Ø³ÙŠØ·.");
      }
    };
  });
}

document.querySelector("#saveCfg").onclick = ()=>{
  db = getDB();
  setUltraMsg(db, document.querySelector("#instanceId").value, document.querySelector("#token").value);
  alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª");
};

document.querySelector("#search").onclick = ()=> render(document.querySelector("#q").value);

document.querySelector("#pay").onclick = ()=>{
  try{
    db = getDB();
    payDebt(db, { debtId: Number(document.querySelector("#debtId").value), amount: document.querySelector("#amount").value });
    alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø³Ø¯Ø§Ø¯");
    render(document.querySelector("#q").value);
  }catch(e){ alert(e.message); }
};

loadCfg();
render();
</script>
</body>
</html>
