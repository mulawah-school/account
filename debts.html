<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="style.css"/>
  <title>ุงูุฏูู ุงููุคุฌู</title>
</head>
<body>
<div class="container">
  <div class="top">
    <a class="badge" href="index.html">โฌ ุงูุฑุฆูุณูุฉ</a>
    <h2>๐ฑ ุงูุฏูู ุงููุคุฌู</h2>
  </div>

  <div class="danger">
    ุชูุจูู: ุญูุธ UltraMsg token ุฏุงุฎู LocalStorage ุบูุฑ ุขูู ุนูู ุงูุงุณุชุถุงูุฉ ุงูุนุงูุฉ (GitHub Pages).
    ููุฏ ุชูุงุฌู CORS. ุฅุฐุง ุชุฑูุฏ โProxyโ ุจุณูุท ุฃุฎุจุฑูู.
  </div>

  <div class="card" style="margin-top:12px">
    <h3>ุฅุนุฏุงุฏุงุช UltraMsg</h3>
    <div class="row">
      <input id="instanceId" placeholder="instance_id"/>
      <input id="token" placeholder="token"/>
      <button id="saveCfg">ุญูุธ</button>
    </div>
  </div>

  <!-- โ ุฅุถุงูุฉ ุฏูู ูุฏูู -->
  <div class="card" style="margin-top:12px">
    <h3>ุฅุถุงูุฉ ุฏูู ูุคุฌู (ูุฏูู)</h3>
    <div class="row">
      <input id="newName" placeholder="ุงุณู ุงูุดุฎุต"/>
      <input id="newPhone" placeholder="ุฑูู ุงููุงุชู (ูุซุงู +968...)"/>
      <input id="newAmount" type="number" step="0.001" placeholder="ูููุฉ ุงูุฏูู (OMR)"/>
      <input id="newDue" placeholder="ุชุงุฑูุฎ ุงูุงุณุชุญูุงู (ุงุฎุชูุงุฑู) YYYY-MM-DD"/>
      <button id="addDebt">ุญูุธ ุงูุฏูู</button>
    </div>
    <div class="small">ุงูุนููุฉ: ุฑูุงู ุนูุงูู (OMR)</div>
  </div>

  <div class="card" style="margin-top:12px">
    <div class="row">
      <input id="q" placeholder="ุจุญุซ ุจุงูุงุณู ุฃู ุงููุงุชู"/>
      <button id="search">ุจุญุซ</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>ID</th><th>ุงูุนููู</th><th>ุงููุงุชู</th>
          <th>ุงูุฃุตู</th><th>ุงููุชุจูู</th><th>ุงูุญุงูุฉ</th><th>ูุงุชุณุงุจ</th>
        </tr>
      </thead>
      <tbody id="tbl"></tbody>
    </table>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>ุณุฏุงุฏ ุฏูู</h3>
    <div class="row">
      <input id="debtId" type="number" placeholder="Debt ID"/>
      <input id="amount" type="number" step="0.001" placeholder="ูุจูุบ ุงูุณุฏุงุฏ (OMR)"/>
      <button id="pay">ุชุณุฌูู ุณุฏุงุฏ</button>
    </div>
  </div>
</div>

<script type="module">
import { getDB, setUltraMsg, payDebt, ultramsgSendChat, createManualDebt } from "./app.js";

let db = getDB();

function loadCfg(){
  db = getDB();
  document.querySelector("#instanceId").value = db.ultramsg?.instanceId || "";
  document.querySelector("#token").value = db.ultramsg?.token || "";
}

function render(q=""){
  db = getDB();
  const t = (q||"").trim();
  const rows = t
    ? db.debts.filter(d => d.customerName.includes(t) || d.customerPhone.includes(t))
    : db.debts;

  document.querySelector("#tbl").innerHTML = rows.map(d=>{
    const cur = d.currency || "OMR";
    return `<tr>
      <td>${d.id}</td>
      <td>${d.customerName}</td>
      <td>${d.customerPhone}</td>
      <td>${Number(d.original).toFixed(3)} ${cur}</td>
      <td>${Number(d.remaining).toFixed(3)} ${cur}</td>
      <td>${d.status}</td>
      <td><button data-id="${d.id}">ุฅุฑุณุงู</button></td>
    </tr>`;
  }).join("");

  document.querySelectorAll("button[data-id]").forEach(btn=>{
    btn.onclick = async ()=>{
      const id = Number(btn.getAttribute("data-id"));
      const debt = getDB().debts.find(x=>x.id===id);
      if(!debt) return alert("ุงูุฏูู ุบูุฑ ููุฌูุฏ");

      const cur = debt.currency || "OMR";
      const msg = `ุงูุณูุงู ุนูููู ${debt.customerName}
ุชุฐููุฑ: ูุฏูู ุฏูู ูุคุฌู ูุชุจูู ${Number(debt.remaining).toFixed(3)} ${cur}
ุดูุฑุงู`;

      try{
        await ultramsgSendChat(getDB(), { to: debt.customerPhone, body: msg });
        alert("ุชู ุงูุฅุฑุณุงู (ุฅุฐุง ูุง ุธูุฑุช ูุดููุฉ CORS)");
      }catch(e){
        alert("ูุดู ุงูุฅุฑุณุงู: " + e.message + "\nููุงุญุธุฉ: ูู ุธูุฑ CORS ุชุญุชุงุฌ Proxy.");
      }
    };
  });
}

document.querySelector("#saveCfg").onclick = ()=>{
  db = getDB();
  setUltraMsg(db, document.querySelector("#instanceId").value, document.querySelector("#token").value);
  alert("ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช");
};

document.querySelector("#addDebt").onclick = ()=>{
  try{
    const db = getDB();
    createManualDebt(db, {
      customerName: document.querySelector("#newName").value,
      customerPhone: document.querySelector("#newPhone").value,
      amount: document.querySelector("#newAmount").value,
      dueDate: document.querySelector("#newDue").value ? (document.querySelector("#newDue").value + " 00:00:00") : ""
    });
    alert("ุชู ุญูุธ ุงูุฏูู");
    document.querySelector("#newName").value = "";
    document.querySelector("#newPhone").value = "";
    document.querySelector("#newAmount").value = "";
    document.querySelector("#newDue").value = "";
    render(document.querySelector("#q").value);
  }catch(e){
    alert(e.message);
  }
};

document.querySelector("#search").onclick = ()=> render(document.querySelector("#q").value);

document.querySelector("#pay").onclick = ()=>{
  try{
    db = getDB();
    payDebt(db, { debtId: Number(document.querySelector("#debtId").value), amount: document.querySelector("#amount").value });
    alert("ุชู ุชุณุฌูู ุงูุณุฏุงุฏ");
    render(document.querySelector("#q").value);
  }catch(e){ alert(e.message); }
};

loadCfg();
render();
</script>
</body>
</html>
