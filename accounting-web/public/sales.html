<!doctype html>
<html lang="ar" dir="rtl">
<head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ø§Ù„Ø¨ÙŠØ¹</title>
<style>
body{font-family:system-ui;margin:24px} input,button,select{padding:10px;border-radius:10px;border:1px solid #ddd}
.row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
table{width:100%;border-collapse:collapse;margin-top:12px} th,td{border:1px solid #eee;padding:8px}
.badge{padding:4px 8px;border:1px solid #ddd;border-radius:999px}
</style>
</head>
<body>
<a href="/">â¬… Ø±Ø¬ÙˆØ¹</a>
<h2>ğŸ§¾ Ø§Ù„Ø¨ÙŠØ¹ (Ø³Ø¹Ø± Ø«Ø§Ø¨Øª)</h2>

<div class="row">
  <input id="searchQ" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ù€ SKU Ø£Ùˆ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" />
  <button id="find">Ø¨Ø­Ø«</button>
</div>

<div class="row">
  <input id="pid" placeholder="ID Ø§Ù„Ù…Ù†ØªØ¬" type="number"/>
  <input id="qty" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©" type="number" step="0.001"/>
  <button id="add">Ø¥Ø¶Ø§ÙØ© Ù„Ù„Ø³Ù„Ø©</button>
  <span class="badge" id="stockInfo">â€”</span>
</div>

<table>
  <thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„ÙƒÙ…ÙŠØ©</th><th>Ø³Ø¹Ø±</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th></tr></thead>
  <tbody id="cart"></tbody>
</table>

<div class="row">
  <select id="payMethod">
    <option value="cash">Ù†Ù‚Ø¯ÙŠ</option>
    <option value="bank">ØªØ­ÙˆÙŠÙ„</option>
    <option value="deferred">Ø¯ÙŠÙ† Ù…Ø¤Ø¬Ù„</option>
  </select>
  <input id="paid" placeholder="Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø§Ù„Ø¢Ù†" type="number" step="0.001" value="0"/>
</div>

<div class="row" id="deferredBox" style="display:none">
  <input id="cname" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" />
  <input id="cphone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ +968..." />
  <input id="due" placeholder="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) YYYY-MM-DD" />
</div>

<div class="row">
  <button id="checkout">Ø­ÙØ¸ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨ÙŠØ¹</button>
  <span class="badge" id="total">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: 0</span>
</div>

<script type="module">
import { api, qs } from "./app.js";

let productsCache = [];
let cart = [];

async function findProducts(q){
  productsCache = await api("/api/products?q="+encodeURIComponent(q));
  if(productsCache[0]) qs("#stockInfo").textContent = `Ù…Ø«Ø§Ù„ Ù†ØªÙŠØ¬Ø©: ${productsCache[0].name} (Ø§Ù„Ù…ØªÙˆÙØ± ${productsCache[0].stock})`;
  else qs("#stockInfo").textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯";
}

function render(){
  const total = cart.reduce((s,it)=> s + it.qty*it.price, 0);
  qs("#cart").innerHTML = cart.map(it=>`
    <tr><td>${it.name}</td><td>${it.qty}</td><td>${it.price}</td><td>${(it.qty*it.price).toFixed(3)}</td></tr>
  `).join("");
  qs("#total").textContent = `Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${total.toFixed(3)}`;
}

qs("#find").onclick = ()=> findProducts(qs("#searchQ").value);

qs("#add").onclick = ()=>{
  const pid = Number(qs("#pid").value);
  const qty = Number(qs("#qty").value);
  const p = productsCache.find(x=> x.id===pid) || productsCache[0];
  if(!p) return alert("Ø§Ø¨Ø­Ø« Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… Ø§Ø®ØªØ± ID Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬");
  if(qty<=0) return alert("ÙƒÙ…ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
  if(qty > p.stock) return alert(`Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù„Ø§ ÙŠÙƒÙÙŠ. Ø§Ù„Ù…ØªÙˆÙØ±: ${p.stock}`);

  cart.push({ product_id: p.id, name: p.name, qty, price: Number(p.sale_price) });
  qs("#stockInfo").textContent = `Ø§Ù„Ù…ØªÙˆÙØ± Ù‚Ø¨Ù„: ${p.stock} | Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¨Ø¹Ø¯: ${(p.stock-qty)}`;
  render();
};

qs("#payMethod").onchange = ()=>{
  qs("#deferredBox").style.display = qs("#payMethod").value==="deferred" ? "flex" : "none";
};

qs("#checkout").onclick = async ()=>{
  if(cart.length===0) return alert("Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©");
  const payment_method = qs("#payMethod").value;
  const body = {
    items: cart.map(x=>({ product_id:x.product_id, qty:x.qty })),
    payment_method,
    paid: Number(qs("#paid").value||0),
    customer_name: qs("#cname").value || null,
    customer_phone: qs("#cphone").value || null,
    due_date: qs("#due").value ? (qs("#due").value+" 00:00:00") : null
  };
  const r = await api("/api/sales","POST",body);
  alert(`ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ¹: ${r.invoice_no} | Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ${r.total}`);
  cart = [];
  render();
};
</script>
</body>
</html>
