<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="style.css"/>
  <title>Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</title>
</head>
<body>
<div class="container">
  <div class="top">
    <a class="badge" href="index.html">â¬… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</a>
    <h2>ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
  </div>

  <div class="card">
    <h3>ÙÙ„ØªØ±Ø© Ø¨Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù…Ù† - Ø¥Ù„Ù‰)</h3>
    <div class="row">
      <input id="from" placeholder="Ù…Ù† (YYYY-MM-DD 00:00:00)"/>
      <input id="to" placeholder="Ø¥Ù„Ù‰ (YYYY-MM-DD 23:59:59)"/>
      <button id="runSales">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨ÙŠØ¹</button>
      <button id="runDebts">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ù„</button>
    </div>
    <div class="small">Ø§Ù„Ø¹Ù…Ù„Ø©: Ø±ÙŠØ§Ù„ Ø¹Ù…Ø§Ù†ÙŠ (OMR)</div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3>Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø­ØªÙ‰ ØªØ§Ø±ÙŠØ®</h3>
    <div class="row">
      <input id="until" placeholder="Ø­ØªÙ‰ (YYYY-MM-DD 23:59:59)"/>
      <button id="runStock">Ø¹Ø±Ø¶</button>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <h3 id="title">â€”</h3>
    <table>
      <thead id="thead"></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

<script type="module">
import { getDB, reportSales, reportDebts, reportStockUntil } from "./app.js";

function setDefaults(){
  const d = new Date();
  const pad = n => String(n).padStart(2,"0");
  const day = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  document.querySelector("#from").value = `${day} 00:00:00`;
  document.querySelector("#to").value = `${day} 23:59:59`;
  document.querySelector("#until").value = `${day} 23:59:59`;
}

function renderTable(rows){
  const thead = document.querySelector("#thead");
  const tbody = document.querySelector("#tbody");
  if(!rows.length){
    thead.innerHTML = "";
    tbody.innerHTML = `<tr><td>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
    return;
  }
  const cols = Object.keys(rows[0]);
  thead.innerHTML = "<tr>" + cols.map(c=>`<th>${c}</th>`).join("") + "</tr>";
  tbody.innerHTML = rows.map(r => "<tr>" + cols.map(c=>`<td>${r[c] ?? ""}</td>`).join("") + "</tr>").join("");
}

document.querySelector("#runSales").onclick = ()=>{
  const db = getDB();
  const from = document.querySelector("#from").value;
  const to = document.querySelector("#to").value;
  const cur = db.currency || "OMR";

  const rows = reportSales(db, from, to).map(s=>({
    date: s.date,
    paymentMethod: s.paymentMethod,
    total: Number(s.total).toFixed(3) + " " + cur,
    paid: Number(s.paid).toFixed(3) + " " + cur,
    customerName: s.customerName,
    customerPhone: s.customerPhone
  }));

  document.querySelector("#title").textContent = "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¨ÙŠØ¹";
  renderTable(rows);
};

document.querySelector("#runDebts").onclick = ()=>{
  const db = getDB();
  const from = document.querySelector("#from").value;
  const to = document.querySelector("#to").value;

  const rows = reportDebts(db, from, to).map(d=>({
    date: d.date,
    customerName: d.customerName,
    customerPhone: d.customerPhone,
    original: Number(d.original).toFixed(3) + " " + (d.currency||"OMR"),
    remaining: Number(d.remaining).toFixed(3) + " " + (d.currency||"OMR"),
    status: d.status,
    dueDate: d.dueDate
  }));

  document.querySelector("#title").textContent = "ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¯ÙŠÙ† Ø§Ù„Ù…Ø¤Ø¬Ù„";
  renderTable(rows);
};

document.querySelector("#runStock").onclick = ()=>{
  const db = getDB();
  const until = document.querySelector("#until").value;

  const rows = reportStockUntil(db, until).map(x=>({
    sku: x.sku,
    name: x.name,
    unit: x.unit,
    stock: Number(x.stock).toFixed(3)
  }));

  document.querySelector("#title").textContent = "Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø­ØªÙ‰ ØªØ§Ø±ÙŠØ®";
  renderTable(rows);
};

setDefaults();
</script>
</body>
</html>
